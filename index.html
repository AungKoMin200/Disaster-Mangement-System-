<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SE-Asia Disaster Alert System</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background: #f4f4f9; }
        header { background: #d32f2f; color: white; padding: 1rem; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .container { display: flex; flex-direction: column; gap: 20px; padding: 20px; max-width: 1200px; margin: auto; }
        
        #map { height: 450px; width: 100%; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 2px solid #fff; }
        
        .admin-panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; gap: 10px; align-items: center; justify-content: center; }
        input { padding: 12px; border: 1px solid #ccc; border-radius: 6px; width: 250px; }
        .btn-alert { background: #d32f2f; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-alert:hover { background: #b71c1c; transform: scale(1.05); }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h3 { margin-top: 0; color: #333; border-bottom: 2px solid #f4f4f9; padding-bottom: 10px; }
        .contact-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        
        @media (max-width: 768px) { .info-grid { grid-template-columns: 1fr; } .admin-panel { flex-direction: column; } }
    </style>
</head>
<body>

<header>
    <h1>üåè Disaster Management Info System</h1>
    <p>Real-time Alerts & Shelter Mapping</p>
</header>

<div class="container">
    <div class="admin-panel">
        <strong>Admin Dashboard:</strong>
        <input type="text" id="disasterInput" placeholder="Enter Disaster (e.g., Tsunami)">
        <button class="btn-alert" onclick="triggerEmergency()">üö® BROADCAST AMBER ALERT</button>
    </div>

    <div id="map"></div>

    <div class="info-grid">
        <div class="card">
            <h3>üìû Emergency Contacts</h3>
            <div class="contact-item"><span>National Emergency</span> <strong>911</strong></div>
            <div class="contact-item"><span>Red Cross</span> <strong>143</strong></div>
            <div class="contact-item"><span>Coast Guard</span> <strong>+63 2 8527-3877</strong></div>
            <div class="contact-item"><span>Disaster Mgmt Office</span> <strong>(02) 8911-1406</strong></div>
        </div>

        <div class="card" style="background: #fffde7;">
            <h3>üéí Survival Preparation</h3>
            <ul>
                <li><strong>Flood:</strong> Move to high ground immediately. Don't touch electric gear.</li>
                <li><strong>Earthquake:</strong> Drop, Cover, and Hold on!</li>
                <li><strong>Kit:</strong> Pack 3 days of water, canned food, and a whistle.</li>
                <li><strong>Safe Zone:</strong> Follow green markers on the map.</li>
            </ul>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignal.js" async=""></script>

<script>
    // --- 1. CONFIGURATION (PASTE YOUR KEYS HERE) ---
    const SUPABASE_URL = 'mltciqawrvxljrhaagsy';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sdGNpcWF3cnZ4bGpyaGFhZ3N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Njc3NTgsImV4cCI6MjA4NzE0Mzc1OH0.2s_3NZQzA7sqtwU4LJ7NYwzR0uTjoqHey2TPGaWn4QU';
    const ONESIGNAL_ID = '8cd45b5c-4368-403c-9caf-ab2c7ed4749c';

    // Initialize Supabase
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Initialize OneSignal
    window.OneSignal = window.OneSignal || [];
    OneSignal.push(function() {
        OneSignal.init({ appId: ONESIGNAL_ID });
    });

    // --- 2. MAP SETUP ---
    var map = L.map('map').setView([14.5995, 120.9842], 12); // Defaults to Manila
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // Add some sample static shelters (Green Markers)
    const shelters = [
        { name: "Shelter A - City Hall", lat: 14.589, lng: 120.981 },
        { name: "Shelter B - University Gym", lat: 14.610, lng: 120.992 }
    ];

    shelters.forEach(s => {
        L.circleMarker([s.lat, s.lng], { color: 'green', radius: 10, fillOpacity: 0.8 }).addTo(map)
            .bindPopup(`<b>SAFE SHELTER:</b><br>${s.name}`);
    });

    // --- 3. REAL-TIME LOGIC ---
    // Listen for new alerts in Supabase
    supabaseClient
        .channel('public:alerts')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'alerts' }, payload => {
            const alertData = payload.new;
            showNewAlertOnMap(alertData);
        })
        .subscribe();

    function showNewAlertOnMap(data) {
        // Show Browser Alert
        alert(`‚ö†Ô∏è EMERGENCY ALERT: ${data.disaster_type} detected! Check the map.`);
        
        // Add Red Danger Zone to Map
        L.circle([data.lat || 14.59, data.lng || 120.98], {
            color: 'red', fillColor: '#f03', fillOpacity: 0.5, radius: 2500
        }).addTo(map).bindPopup(`<b>CRITICAL: ${data.disaster_type}</b>`).openPopup();
    }

    // --- 4. TRIGGER FUNCTION ---
    async function triggerEmergency() {
        const type = document.getElementById('disasterInput').value;
        if(!type) return alert("Please enter a disaster type");

        const { error } = await supabaseClient
            .from('alerts')
            .insert([{ 
                disaster_type: type, 
                location_name: 'Metropolitan Area',
                lat: 14.5995, 
                lng: 120.9842 
            }]);

        if (error) console.error("Database Error:", error);
        else console.log("Alert broadcasted successfully!");
    }
</script>

</body>
</html>